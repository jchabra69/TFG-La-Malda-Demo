<section class="bg-white p-5">
  <header class="flex justify-between items-center mb-4">
    <div>
      <h1 class="m-0 text-4xl leading-tight font-display font-bold">Usuarios</h1>
      <p class="mt-1 mb-0 text-text-secondary text-base">Aquí podrás activar un usuario y visualizar los existentes, además de editar sus datos o Rol</p>
    </div>
    <button
      class="bg-black text-white border-none rounded-[10px] px-5 py-[0.65rem] font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 hover:bg-black hover:-translate-y-px"
      (click)="crear()"
    >
      <i class="fa-solid fa-user-plus"></i>
      Nuevo usuario
    </button>
  </header>

  @if (cargando()) {
    <div class="grid place-items-center py-12">
      <div class="w-10 h-10 rounded-full border-4 border-[#e5e7eb] border-t-black animate-spin"></div>
    </div>
  } @else {
    <div class="grid gap-4">
      <div class="bg-white rounded-xl shadow-[0_10px_24px_rgba(0,0,0,0.05)] overflow-hidden">
        <table class="w-full border-collapse">
          <thead>
            <tr>
              <th class="px-4 py-[0.85rem] text-left border-b border-[#eef0f4] text-[0.95rem] bg-[#fafafa] font-bold">ID</th>
              <th class="px-4 py-[0.85rem] text-left border-b border-[#eef0f4] text-[0.95rem] bg-[#fafafa] font-bold">Usuario</th>
              <th class="px-4 py-[0.85rem] text-left border-b border-[#eef0f4] text-[0.95rem] bg-[#fafafa] font-bold">Email</th>
              <th class="px-4 py-[0.85rem] text-left border-b border-[#eef0f4] text-[0.95rem] bg-[#fafafa] font-bold">Teléfono</th>
              <th class="px-4 py-[0.85rem] text-left border-b border-[#eef0f4] text-[0.95rem] bg-[#fafafa] font-bold">Rol</th>
              <th class="px-4 py-[0.85rem] text-left border-b border-[#eef0f4] text-[0.95rem] bg-[#fafafa] font-bold">Estado</th>
              <th class="px-4 py-[0.85rem] text-left border-b border-[#eef0f4] text-[0.95rem] bg-[#fafafa] font-bold"></th>
            </tr>
          </thead>
          <tbody>
            @for (usuario of usuarios(); track usuario.id) {
              <tr>
                <td class="px-4 py-[0.85rem] border-b border-[#eef0f4] text-[0.95rem]">
                  <span class="text-xs font-semibold px-3 py-1 rounded-full bg-[#f3f4f6] text-[#374151]">
                    #{{ usuario.id }}
                  </span>
                </td>
                <td class="px-4 py-[0.85rem] border-b border-[#eef0f4] text-[0.95rem]">
                  <p class="font-bold m-0">{{ usuario.nombre }} {{ usuario.apellidos }}</p>
                </td>
                <td class="px-4 py-[0.85rem] border-b border-[#eef0f4] text-[0.95rem]">{{ usuario.email }}</td>
                <td class="px-4 py-[0.85rem] border-b border-[#eef0f4] text-[0.95rem]">{{ usuario.telefono }}</td>
                <td class="px-4 py-[0.85rem] border-b border-[#eef0f4] text-[0.95rem]">
                  <span
                    [class]="usuario.rol === 'ADMIN'
                      ? 'inline-flex items-center justify-center px-[0.6rem] py-1 rounded-full text-xs font-bold bg-[#fee2e2] text-[#b91c1c]'
                      : 'inline-flex items-center justify-center px-[0.6rem] py-1 rounded-full text-xs font-bold text-black bg-[#eef0f4]'"
                  >
                    {{ usuario.rol }}
                  </span>
                </td>
                <td class="px-4 py-[0.85rem] border-b border-[#eef0f4] text-[0.95rem]">
                  <button
                    [class]="usuario.activo
                      ? 'border-none px-3 py-[0.35rem] rounded-full text-xs font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-[0.35rem] bg-[#dcfce7] text-[#166534] hover:bg-[#bbf7d0]'
                      : 'border-none px-3 py-[0.35rem] rounded-full text-xs font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-[0.35rem] bg-[#fee2e2] text-[#b91c1c] hover:bg-[#fecaca]'"
                    (click)="alternarActivo(usuario)"
                    title="Cambiar estado"
                  >
                    <i [class]="usuario.activo ? 'fa-solid fa-circle-check' : 'fa-solid fa-circle-xmark'"></i>
                    {{ usuario.activo ? 'Activo' : 'Inactivo' }}
                  </button>
                </td>
                <td class="px-4 py-[0.85rem] border-b border-[#eef0f4] text-[0.95rem]">
                  <div class="inline-flex gap-[0.35rem]">
                    <button
                      class="w-[34px] h-[34px] inline-flex items-center justify-center border border-[#e5e7eb] rounded-lg bg-white cursor-pointer transition-all duration-200 hover:border-black hover:text-black"
                      (click)="editar(usuario)"
                      title="Editar"
                    >
                      <i class="fa-solid fa-pen"></i>
                    </button>
                    <button
                      class="w-[34px] h-[34px] inline-flex items-center justify-center border border-[#f0c5cb] rounded-lg bg-white cursor-pointer transition-all duration-200 text-[#c62030] hover:bg-[#c62030] hover:text-white hover:border-[#c62030]"
                      (click)="eliminar(usuario.id)"
                      title="Eliminar"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-[#6b7280]">No hay usuarios registrados</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
</section>

@if (mostrandoFormulario()) {
  <div class="fixed inset-0 bg-black/50 grid place-items-center z-[1000] overflow-y-auto py-8 px-4" (click)="cancelar()">
    <div class="bg-white rounded-2xl w-full max-w-[600px] shadow-[0_20px_60px_rgba(0,0,0,0.3)]" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-center px-7 py-6 border-b border-[#e5e7eb]">
        <h3 class="m-0 text-2xl font-bold">{{ editandoId() ? 'Editar usuario' : 'Nuevo usuario' }}</h3>
        <button
          class="w-9 h-9 rounded-lg border border-[#e5e7eb] bg-white cursor-pointer transition-all duration-200 flex items-center justify-center hover:bg-[#f3f4f6] hover:border-[#d1d5db]"
          (click)="cancelar()"
        >
          <i class="fa-solid fa-times"></i>
        </button>
      </div>

      <form (ngSubmit)="guardar()" #usuarioForm="ngForm" class="px-7 py-7">
        <div class="grid grid-cols-2 gap-4 mb-4 mobile:grid-cols-1">
          <div class="mb-4">
            <label class="block font-bold text-[0.9rem] mb-2 text-[#374151]">Nombre *</label>
            <input
              type="text"
              name="nombre"
              [(ngModel)]="form.nombre"
              class="w-full px-[0.85rem] py-[0.65rem] border border-[#e5e7eb] rounded-[10px] text-[0.95rem] transition-all duration-200 focus:outline-none focus:border-black focus:shadow-[0_0_0_3px_rgba(0,0,0,0.05)] placeholder:text-[#9ca3af]"
              required

            />
          </div>

          <div class="mb-4">
            <label class="block font-bold text-[0.9rem] mb-2 text-[#374151]">Apellidos *</label>
            <input
              type="text"
              name="apellidos"
              [(ngModel)]="form.apellidos"
              class="w-full px-[0.85rem] py-[0.65rem] border border-[#e5e7eb] rounded-[10px] text-[0.95rem] transition-all duration-200 focus:outline-none focus:border-black focus:shadow-[0_0_0_3px_rgba(0,0,0,0.05)] placeholder:text-[#9ca3af]"
              required

            />
          </div>
        </div>

        <div class="mb-4">
          <label class="block font-bold text-[0.9rem] mb-2 text-[#374151]">Email *</label>
          <input
            type="email"
            name="email"
            [(ngModel)]="form.email"
            class="w-full px-[0.85rem] py-[0.65rem] border border-[#e5e7eb] rounded-[10px] text-[0.95rem] transition-all duration-200 focus:outline-none focus:border-black focus:shadow-[0_0_0_3px_rgba(0,0,0,0.05)] placeholder:text-[#9ca3af]"
            required
            placeholder="correo@gmail.com"
          />
        </div>

        <div class="mb-4">
          <label class="block font-bold text-[0.9rem] mb-2 text-[#374151]">Teléfono *</label>
          <input
            type="tel"
            name="telefono"
            [(ngModel)]="form.telefono"
            class="w-full px-[0.85rem] py-[0.65rem] border border-[#e5e7eb] rounded-[10px] text-[0.95rem] transition-all duration-200 focus:outline-none focus:border-black focus:shadow-[0_0_0_3px_rgba(0,0,0,0.05)] placeholder:text-[#9ca3af]"
            required
            placeholder="+34 777 777 777"
          />
        </div>

        @if (!editandoId()) {
          <div class="mb-4">
            <label class="block font-bold text-[0.9rem] mb-2 text-[#374151]">Contraseña *</label>
            <input
              type="password"
              name="password"
              [(ngModel)]="form.password"
              class="w-full px-[0.85rem] py-[0.65rem] border border-[#e5e7eb] rounded-[10px] text-[0.95rem] transition-all duration-200 focus:outline-none focus:border-black focus:shadow-[0_0_0_3px_rgba(0,0,0,0.05)] placeholder:text-[#9ca3af]"
              required
              placeholder="••••••••"
              minlength="6"
            />
            <p class="text-xs text-[#6b7280] mt-1">Mínimo 6 caracteres</p>
          </div>
        }

        <div class="grid grid-cols-2 gap-4 mb-4 mobile:grid-cols-1">
          <div class="mb-4">
            <label class="block font-bold text-[0.9rem] mb-2 text-[#374151]">Rol *</label>
            <select
              name="rol"
              [(ngModel)]="form.rol"
              class="w-full px-[0.85rem] py-[0.65rem] border border-[#e5e7eb] rounded-[10px] text-[0.95rem] bg-white cursor-pointer transition-all duration-200 focus:outline-none focus:border-black focus:shadow-[0_0_0_3px_rgba(0,0,0,0.05)]"
              required
            >
              <option value="CLIENTE">Cliente</option>
              <option value="ADMIN">Administrador</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="block font-bold text-[0.9rem] mb-2 text-[#374151]">Estado</label>
            <div class="mt-2">
              <label class="flex items-center gap-2 cursor-pointer select-none">
                <input
                  type="checkbox"
                  name="activo"
                  [(ngModel)]="form.activo"
                  class="w-[18px] h-[18px] cursor-pointer"
                />
                <span class="font-semibold text-[#374151]">Usuario activo</span>
              </label>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 px-7 py-6 border-t border-[#e5e7eb]">
          <button
            type="button"
            class="bg-[#f5f5f5] text-black border border-[#e5e7eb] rounded-[10px] px-5 py-[0.65rem] font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 hover:bg-[#e5e5e5]"
            (click)="cancelar()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="bg-black text-white border-none rounded-[10px] px-5 py-[0.65rem] font-bold cursor-pointer transition-all duration-200 inline-flex items-center gap-2 hover:bg-black hover:-translate-y-px disabled:opacity-50 disabled:cursor-not-allowed"
            [disabled]="usuarioForm.invalid"
          >
            <i class="fa-solid fa-check"></i>
            {{ editandoId() ? 'Actualizar' : 'Crear' }} usuario
          </button>
        </div>
      </form>
    </div>
  </div>
}
