<nav class="barra-navegacion" role="navigation" aria-label="Navegación principal">
  <div class="barra-navegacion-container">

    <div class="nav-izq" aria-label="Atajos principales">
      <button
        class="boton-menu boton-menu--desktop"
        type="button"
        (click)="alternarMegaLateral('MUJER')"
        [attr.aria-expanded]="!!megaLateralAbierto()"
        aria-label="Mostrar u ocultar menú"
        title="Abrir menú">
        <span></span><span></span><span></span>
      </button>
      <span class="etiqueta-menu">Menú</span>
      <div class="nav-izq-spacer" aria-hidden="true"></div>
      <nav class="nav-izq-links" aria-label="Enlaces rápidos"></nav>
    </div>

    <a
      routerLink="/"
      class="marca"
      [class.marca--compact]="!mostrarLogotipo"
      aria-label="Ir a la página de inicio"
      title="Ir a la página de inicio">
      <span class="isotipo" aria-hidden="true">
        <img src="/icons/mlogo.svg" alt="" />
      </span>
      <span class="logotipo" [class.logotipo--hidden]="!mostrarLogotipo">LA MALDA'</span>
    </a>

    <ul class="menu-nav center">
      <li class="item-nav">
        <button
          class="enlace-nav"
          type="button"
          aria-haspopup="true"
          [attr.aria-controls]="'mega-lateral-MUJER'"
          [attr.aria-expanded]="megaLateralEstaAbierto('MUJER')"
          (click)="alternarMegaLateral('MUJER')">MUJER</button>
      </li>
      <li class="item-nav">
        <button
          class="enlace-nav"
          type="button"
          aria-haspopup="true"
          [attr.aria-controls]="'mega-lateral-HOMBRE'"
          [attr.aria-expanded]="megaLateralEstaAbierto('HOMBRE')"
          (click)="alternarMegaLateral('HOMBRE')">HOMBRE</button>
      </li>
      <li class="item-nav">
        <a routerLink="/sobre-nosotros" routerLinkActive="active" class="enlace-nav">NOSOTROS</a>
      </li>
    </ul>

    <div class="acciones-nav right">

      @if (authService.esAdmin()) {
        <button
          class="btn-icono"
          type="button"
          routerLink="/admin"
          routerLinkActive="active"
          aria-label="Panel de administración"
          title="Abrir panel de administración">
          <lucide-icon name="shield" [size]="20" strokeWidth="2.2" aria-hidden="true"></lucide-icon>
        </button>
      }

      <div class="contenedor-usuario">
        @if (!authService.estaAutenticado()) {
          <button
            class="btn-icono"
            type="button"
            (click)="abrirModalAuth()"
            aria-label="Cuenta"
            title="Iniciar sesión o registrarse">
            <lucide-icon name="user" [size]="20" strokeWidth="2.4" aria-hidden="true"></lucide-icon>
          </button>
        }

        @if (authService.estaAutenticado()) {
          <div class="menu-usuario"
               (mouseenter)="abrirUserMenu()"
               (mouseleave)="cerrarUserMenu()"
               [class.abierto]="userMenuAbierto()">
            <button class="btn-icono avatar-usuario" type="button" aria-label="Menú de cuenta" title="Abrir menú de usuario">
              <span class="avatar-initials">{{ authService.inicialesUsuario() }}</span>
            </button>

            <div class="user-dropdown"
                 (mouseenter)="mantenerUserMenuAbierto()"
                 (mouseleave)="cerrarUserMenu()">
              <div class="cabecera-dropdown">
                <span class="nombre-usuario">{{ authService.usuarioActual()?.nombre }}</span>
                <span class="correo-usuario">{{ authService.usuarioActual()?.email }}</span>
              </div>
              <div class="separador-dropdown"></div>
              <a routerLink="/mi-perfil" class="item-dropdown">
                <lucide-icon name="user" [size]="18" strokeWidth="2.4" aria-hidden="true"></lucide-icon>
                Mi perfil
              </a>
              <a routerLink="/mi-perfil" [queryParams]="{ seccion: 'pedidos' }" class="item-dropdown">
                <lucide-icon name="box" [size]="18" strokeWidth="2.4" aria-hidden="true"></lucide-icon>
                Mis pedidos
              </a>
              <!--
              <a routerLink="/favoritos" class="item-dropdown">
                <lucide-icon name="heart" [size]="18" strokeWidth="2.4" aria-hidden="true"></lucide-icon>
                Favoritos
              </a>
              -->
              <div class="separador-dropdown"></div>
              <button class="item-dropdown cerrarSesion" (click)="cerrarSesion()">
                <lucide-icon name="log-out" [size]="18" strokeWidth="2.4" aria-hidden="true"></lucide-icon>
                Cerrar sesión
              </button>
            </div>
          </div>
        }
      </div>

      <!--
      @if (authService.estaAutenticado()) {
        <button
          class="btn-icono solo-desktop"
          type="button"
          routerLink="/favoritos"
          aria-label="Favoritos"
          title="Ver favoritos">
          <lucide-icon name="heart" [size]="20" strokeWidth="2.4" aria-hidden="true"></lucide-icon>
        </button>
      }
      -->

      <div class="carrito-wrapper" (mouseenter)="abrirMiniCarrito()" (mouseleave)="cerrarMiniCarrito()">
      <button class="btn-icono carrito" type="button" routerLink="/carrito" aria-label="Carrito" title="Ver carrito">
        <lucide-icon name="shopping-cart" [size]="20" strokeWidth="2.4" aria-hidden="true"></lucide-icon>
        <span class="carrito-count">{{ carritoService.contadorProd() }}</span>
      </button>
        <div class="mini-carrito" *ngIf="miniCarritoAbierto()" (mouseenter)="mantenerMiniCarritoAbierto()" (mouseleave)="cerrarMiniCarrito()">
          <div class="mini-header">
          <span>
            {{ carritoService.contadorProd() }}
            {{ carritoService.contadorProd() === 1 ? 'producto' : 'productos' }}
          </span>
        </div>
        <div class="mini-items" *ngIf="carritoService.carrito()?.productos?.length; else miniVacio">
          <div class="mini-item" *ngFor="let item of carritoService.carrito()?.productos | slice:0:3">
            <button
              type="button"
              class="mini-remove"
              aria-label="Eliminar del carrito"
              (click)="eliminarDelMiniCarrito(item.id, $event)">
              <lucide-icon name="trash-2" [size]="16" strokeWidth="2.4" aria-hidden="true"></lucide-icon>
            </button>
            <div class="mini-thumb" *ngIf="item.imagenUrl">
              <img [src]="item.imagenUrl" [alt]="item.nombreProducto">
            </div>
            <div class="mini-data">
              <div class="mini-nombre">{{ item.nombreProducto }}</div>
              <div class="mini-detalles">
                <span *ngIf="item.color">Color: {{ item.color }}</span>
                <span *ngIf="item.talla">Talla: {{ item.talla }}</span>
              </div>
              <div class="mini-precio">
                <span>{{ item.cantidad }} x {{ item.precioUnitario | currency:'EUR':'symbol':'1.2-2' }}</span>
              </div>
            </div>
          </div>
          <div class="mini-total-section" *ngIf="carritoService.carrito()?.subtotal">
            <span class="mini-total-label">Total:</span>
            <span class="mini-total-price">{{ carritoService.carrito()?.subtotal | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <a class="mini-ver-carrito" routerLink="/carrito">Ver carrito</a>
        </div>
        <ng-template #miniVacio>
          <div class="mini-empty">Carrito vacío</div>
        </ng-template>
      </div>
      </div>
    </div>

    <button
      class="boton-menu boton-menu--mobile"
      type="button"
      (click)="alternarMenu()"
      [attr.aria-expanded]="menuAbierto"
      aria-label="Mostrar u ocultar menú"
      title="Abrir menú">
      <span></span><span></span><span></span>
    </button>

  </div>

  <div class="mega-lateral-overlay"
       [class.active]="!!megaLateralAbierto()"
       (click)="cerrarMegaLateral()"
       aria-hidden="true"></div>

  <aside
    class="mega-lateral"
    role="dialog"
    [id]="'mega-lateral-' + (megaLateralAbierto() || 'none')"
    [class.active]="!!megaLateralAbierto()"
    (keydown.escape)="cerrarMegaLateral()"
    aria-modal="false">

    <div class="mega-lateral__tabs" role="tablist" aria-label="Explorar categorías">
      <button role="tab"
              [attr.aria-selected]="megaLateralAbierto() === 'MUJER'"
              (click)="abrirMegaLateral('MUJER')">Mujer</button>
      <button role="tab"
              [attr.aria-selected]="megaLateralAbierto() === 'HOMBRE'"
              (click)="abrirMegaLateral('HOMBRE')">Hombre</button>
    </div>

    @if (megaLateralAbierto(); as gender) {
      <div class="mega-simple">
        <div class="mega-simple__col mega-simple__col--left">
          <div class="mega-simple__title">Compra por categorías</div>
          <div class="mega-simple__tree">
            @for (parent of (gender === 'MUJER' ? categoriasMujer() : categoriasHombre()); track parent.id) {
              <div class="mega-simple__parent">
                <button
                  class="mega-simple__parent-btn"
                  type="button"
                  (click)="alternarPadreMega(parent.slug)">
                  <span class="mega-simple__parent-text">{{ parent.nombre }}</span>
                  @if (parent.subcategorias?.length) {
                    <span class="chev" [class.chev--open]="padreMegaExpandidoEs(parent.slug)"></span>
                  }
                </button>
                @if (parent.subcategorias?.length && padreMegaExpandidoEs(parent.slug)) {
                  <ul class="mega-simple__children">
                    @for (child of parent.subcategorias; track child.id) {
                      <li>
                        @if (child.subcategorias?.length) {
                          <button
                            class="mega-simple__child-btn"
                            type="button"
                            (click)="alternarHijoMega(child.slug)">
                            <span>{{ child.nombre }}</span>
                            <span class="chev-small" [class.chev-small--open]="hijoMegaExpandidoEs(child.slug)"></span>
                          </button>
                          @if (hijoMegaExpandidoEs(child.slug)) {
                            <ul class="mega-simple__grandchildren">
                              @for (grandchild of child.subcategorias; track grandchild.id) {
                                <li>
                                  <a
                                    [routerLink]="['/catalogo']"
                                    [queryParams]="{ categoriaSlug: grandchild.slug }"
                                    class="mega-simple__grandchild-link">
                                    {{ grandchild.nombre }}
                                  </a>
                                </li>
                              }
                            </ul>
                          }
                        } @else {
                          <a
                            [routerLink]="['/catalogo']"
                            [queryParams]="{ categoriaSlug: child.slug }"
                            class="mega-simple__child-link">
                            {{ child.nombre }}
                          </a>
                        }
                      </li>
                    }
                  </ul>
                }
              </div>
            }
          </div>
        </div>

        <div class="mega-simple__col mega-simple__col--right">
          <div class="mega-simple__cards">
            @for (card of tarjetasDecorativas; track card.img) {
              <div class="mega-card" aria-hidden="true">
                <div class="mega-card__img">
                  <img [src]="card.img" [alt]="card.alt" />
                </div>
              </div>
            }
          </div>
          <div class="mega-simple__hero">
            <img [src]="bannerCelebs.img" [alt]="bannerCelebs.alt" />
          </div>
          <a
            class="mega-simple__view-all"
            [routerLink]="['/catalogo']"
            [queryParams]="{ categoriaSlug: gender === 'MUJER' ? 'mujer' : 'hombre' }">
            Ver todo {{ gender === 'MUJER' ? 'Mujer' : 'Hombre' }}
          </a>
        </div>
      </div>
    }

    <div class="mega-lateral__footer">
      @if (authService.estaAutenticado()) {
        <a routerLink="/mi-perfil" class="link-underline">Mi perfil</a>
        <button type="button" class="link-underline" (click)="cerrarSesion()">Cerrar sesión</button>
      } @else {
        <button type="button" class="link-underline" (click)="abrirModalAuth()">Mi perfil</button>
        <button type="button" class="link-underline" (click)="abrirModalAuth()">Iniciar sesión</button>
      }
    </div>
  </aside>
</nav>

<div class="mobile-drawer" [class.active]="menuAbierto">
  <div class="drawer-content">
    @if (authService.estaAutenticado()) {
      <div class="drawer-user">
        <span class="avatar-usuario">{{ authService.inicialesUsuario() }}</span>
        <div>
          <strong>{{ authService.usuarioActual()?.nombre }}</strong>
          <span>{{ authService.usuarioActual()?.email }}</span>
        </div>
      </div>
    }

    <ul class="drawer-menu">
      <li>
        <button (click)="alternarSeccionMovil('MUJER')">Mujer</button>
        @if (seccionMovilEstaAbierta('MUJER')) {
          <ul class="drawer-sublist">
            @for (parent of categoriasMujer(); track parent.id) {
              <li>
                <a
                  [routerLink]="['/catalogo']"
                  [queryParams]="{ categoriaSlug: parent.slug }"
                  (click)="cerrarMenu()">
                  {{ parent.nombre }}
                </a>
              </li>
            }
          </ul>
        }
      </li>

      <li>
        <button (click)="alternarSeccionMovil('HOMBRE')">Hombre</button>
        @if (seccionMovilEstaAbierta('HOMBRE')) {
          <ul class="drawer-sublist">
            @for (parent of categoriasHombre(); track parent.id) {
              <li>
                <a
                  [routerLink]="['/catalogo']"
                  [queryParams]="{ categoriaSlug: parent.slug }"
                  (click)="cerrarMenu()">
                  {{ parent.nombre }}
                </a>
              </li>
            }
          </ul>
        }
      </li>

      <div class="drawer-divider"></div>
      <li><a routerLink="/tienda/novedades" (click)="cerrarMenu()">NOVEDADES</a></li>
      <div class="drawer-divider"></div>

      @if (authService.estaAutenticado()) {
        <li><a routerLink="/perfil" (click)="cerrarMenu()">Mi perfil</a></li>
        <li><a routerLink="/pedidos" (click)="cerrarMenu()">Mis pedidos</a></li>
        <!-- <li><a routerLink="/favoritos" (click)="cerrarMenu()">Favoritos</a></li> -->
      }

      @if (!authService.estaAutenticado()) {
        <li>
          <button (click)="abrirModalAuth(); cerrarMenu()">Iniciar sesión / Regístrate</button>
        </li>
      }

      <div class="drawer-divider"></div>

      <li class="mobile-control">
        <button type="button">Cambiar idioma</button>
      </li>

      @if (authService.estaAutenticado()) {
        <li>
          <button class="cerrarSesion-btn" (click)="cerrarSesion(); cerrarMenu()">Cerrar sesión</button>
        </li>
      }
    </ul>
  </div>
</div>

<div class="mobile-overlay" [class.active]="menuAbierto" (click)="cerrarMenu()"></div>
